<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monthly Expenses Tracker</title>
</head>

<body style="
  margin:0; min-height:100vh; display:grid; grid-template-rows:1fr auto;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:#ffffff;
  background: linear-gradient(180deg, rgba(8,17,28,0.80), rgba(8,17,28,0.85)),
    url('https://images.unsplash.com/photo-1543512218-d4d483b70f37?auto=format&fit=crop&w=1800&q=80') center/cover no-repeat fixed;
">

  <div style="display:flex;align-items:center;justify-content:center;padding:48px 16px;">
    <div style="width:100%;max-width:900px;">
      <h1 style="margin:0 0 8px 0;font-weight:700;text-align:center;">Monthly Expenses Tracker</h1>
      <p style="text-align:center;color:#cbd5e1;font-size:14px;margin:0 0 18px 0;">
        A minimal, experimentative budgeting tool for living in London.
      </p>

      <div style="
        background:rgba(255,255,255,0.08);
        backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
        border-radius:20px; padding:24px;
        border:1px solid rgba(255,255,255,0.18);
        box-shadow:0 10px 30px rgba(0,0,0,0.35);
      ">

        <!-- Top bar -->
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px;">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <label style="display:flex;gap:10px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.08);">
              <span>Month</span>
              <input id="monthInput" type="month" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;">
            </label>
            <span style="color:#cbd5e1;font-size:12px;">Auto-calculates as you type</span>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button id="resetBtn" style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.22);background:rgba(255,255,255,0.16);color:#fff;cursor:pointer;">
              Reset
            </button>
            <button id="exportBtn" style="padding:12px 14px;border-radius:12px;border:none;background:#0ea5e9;color:#082032;font-weight:600;cursor:pointer;">
              Export CSV
            </button>
          </div>
        </div>

        <!-- Two-column grid -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">

          <!-- Expenses -->
          <div>
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:8px;">Rent <span style="color:#93c5fd;font-size:12px;">(Priority)</span></label>
              <div style="position:relative;">
                <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#93c5fd;font-weight:600;">£</span>
                <input id="rent" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal"
                  style="width:100%;padding:14px 12px 14px 38px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;outline:none;">
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:8px;">Council Tax <span style="color:#93c5fd;font-size:12px;">(Priority)</span></label>
              <div style="position:relative;">
                <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#93c5fd;font-weight:600;">£</span>
                <input id="council" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal"
                  style="width:100%;padding:14px 12px 14px 38px;border-radius:12px;border:1px solid rgba(255,255,255,0.10);color:#fff;outline:none;border:1px solid rgba(255,255,255,0.18);">
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:8px;">Wi-Fi / Broadband <span style="color:#93c5fd;font-size:12px;">(Priority)</span></label>
              <div style="position:relative;">
                <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#93c5fd;font-weight:600;">£</span>
                <input id="wifi" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal"
                  style="width:100%;padding:14px 12px 14px 38px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;outline:none;">
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:8px;">Electricity <span style="color:#93c5fd;font-size:12px;">(Priority)</span></label>
              <div style="position:relative;">
                <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#93c5fd;font-weight:600;">£</span>
                <input id="electricity" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal"
                  style="width:100%;padding:14px 12px 14px 38px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;outline:none;">
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:8px;">Water</label>
              <div style="position:relative;">
                <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#93c5fd;font-weight:600;">£</span>
                <input id="water" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal"
                  style="width:100%;padding:14px 12px 14px 38px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;outline:none;">
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:8px;">Subscriptions</label>
              <div style="position:relative;">
                <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#93c5fd;font-weight:600;">£</span>
                <input id="subscriptions" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal"
                  style="width:100%;padding:14px 12px 14px 38px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;outline:none;">
              </div>
            </div>
          </div>

          <!-- Partner & extras -->
          <div>
            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:8px;">Partner Split</label>

              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <label style="display:flex;gap:8px;align-items:center;">
                  <input id="partnerToggle" type="checkbox">
                  Add partner + incomes
                </label>

                <label style="display:flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px dashed rgba(255,255,255,0.30);">
                  <input type="radio" name="splitType" id="splitIncomeAll" value="income_all" checked>
                  By income (all)
                </label>

                <label style="display:flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px dashed rgba(255,255,255,0.30);">
                  <input type="radio" name="splitType" id="splitIncomePriority" value="income_priority">
                  Income priority + 50/50 rest
                </label>

                <label style="display:flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px dashed rgba(255,255,255,0.30);">
                  <input type="radio" name="splitType" id="splitEqual" value="equal">
                  Equal
                </label>

                <label style="display:flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px dashed rgba(255,255,255,0.30);">
                  <input type="radio" name="splitType" id="splitPercent" value="percent">
                  Percentage
                </label>
              </div>

              <div id="incomeRow" style="display:none;margin-top:10px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                  <div style="position:relative;">
                    <div style="color:#cbd5e1;font-size:12px;margin-bottom:6px;">Your monthly income</div>
                    <span style="position:absolute;left:10px;top:34px;transform:translateY(-50%);color:#93c5fd;font-weight:600;">£</span>
                    <input id="youIncome" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal"
                      style="width:100%;padding:12px 12px 12px 38px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;outline:none;">
                  </div>

                  <div style="position:relative;">
                    <div style="color:#cbd5e1;font-size:12px;margin-bottom:6px;">Partner monthly income</div>
                    <span style="position:absolute;left:10px;top:34px;transform:translateY(-50%);color:#93c5fd;font-weight:600;">£</span>
                    <input id="partnerIncome" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal"
                      style="width:100%;padding:12px 12px 12px 38px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;outline:none;">
                  </div>
                </div>
                <div style="margin-top:8px;color:#cbd5e1;font-size:12px;">
                  “Income priority + 50/50 rest” = Rent/Electricity/Council/Wi-Fi split by income; everything else split 50/50.
                </div>
              </div>

              <div id="percentRow" style="display:none;margin-top:10px;color:#cbd5e1;font-size:12px;">
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                  <span>Your share %</span>
                  <input id="youPct" type="number" min="0" max="100" step="1" value="50"
                    style="width:90px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;">
                  <span>Partner % = <span id="partnerPctText">50</span></span>
                </div>
              </div>

              <div id="warnBox" style="display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(248,113,113,0.5);background:rgba(248,113,113,0.12);color:#fee2e2;font-size:12px;">
                Please enter both incomes (or switch split type). Calculations still run, but income-based splits need incomes.
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <label style="display:block;margin-bottom:8px;">Extra Expenses</label>
              <div id="extras"></div>

              <div style="display:flex;gap:10px;margin-top:8px;">
                <button id="addExtraBtn" style="padding:12px 14px;border-radius:12px;border:1px dashed rgba(255,255,255,0.30);background:transparent;color:#fff;cursor:pointer;">
                  + Add extra
                </button>
              </div>

              <div style="color:#cbd5e1;font-size:12px;">Add custom lines (e.g., travel, books, gym).</div>
            </div>
          </div>

        </div>

        <!-- Inline results summary -->
        <div id="inlineResults" style="margin-top:14px;text-align:center;color:#e5e7eb;">
          <div>Priority bills (Rent + Electricity + Council Tax + Wi-Fi): <strong id="inlinePriority">£0.00</strong></div>
          <div style="margin-top:6px;">Monthly total: <strong id="inlineMonthly">£0.00</strong></div>
          <div>Yearly total: <strong id="inlineYearly">£0.00</strong></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Floating Results -->
  <button id="fabBtn" style="position:fixed;bottom:22px;right:22px;padding:12px 14px;border-radius:999px;border:none;background:#0ea5e9;color:#082032;font-weight:600;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.35);">
    Results
  </button>

  <div id="panel" style="position:fixed;bottom:90px;right:22px;max-width:400px;background:rgba(255,255,255,0.10);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.20);border-radius:16px;padding:16px;display:none;">
    <div style="font-weight:600;margin-bottom:8px;">
      Results <span id="monthLabel" style="color:#cbd5e1;font-size:12px;"></span>
    </div>

    <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Priority bills total</span><strong id="priorityTotal">£0.00</strong></div>
    <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Monthly total</span><strong id="monthlyTotal">£0.00</strong></div>
    <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Yearly total</span><strong id="yearlyTotal">£0.00</strong></div>

    <div id="partnerBreak" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.18);">
      <div style="color:#cbd5e1;font-size:12px;margin-bottom:6px;">
        Split: <span id="splitDesc">By income (all)</span>
      </div>

      <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Your share (all bills)</span><strong id="yourShare">£0.00</strong></div>
      <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Partner share (all bills)</span><strong id="partnerShare">£0.00</strong></div>

      <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Your share (priority)</span><strong id="yourPriorityShare">£0.00</strong></div>
      <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Partner share (priority)</span><strong id="partnerPriorityShare">£0.00</strong></div>

      <div style="margin-top:10px;color:#cbd5e1;font-size:12px;">
        <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Your income</span><strong id="youIncomeOut">£0.00</strong></div>
        <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Partner income</span><strong id="partnerIncomeOut">£0.00</strong></div>
        <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Your leftover after bills</span><strong id="youLeftover">£0.00</strong></div>
        <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Partner leftover after bills</span><strong id="partnerLeftover">£0.00</strong></div>
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:14px;color:#cbd5e1;font-size:13px;">
    Created by <strong>Shounak Bhattacharjee</strong>
  </footer>

  <script>
    // Helpers
    function byId(id){ return document.getElementById(id); }
    function toGBP(n){ return "£" + (Number(n || 0)).toFixed(2); }
    function num(id){ return parseFloat(byId(id).value) || 0; }

    const extrasEl = byId('extras');

    const partnerTgl = byId('partnerToggle');
    const splitIncomeAll = byId('splitIncomeAll');
    const splitIncomePriority = byId('splitIncomePriority');
    const splitEqual = byId('splitEqual');
    const splitPercent = byId('splitPercent');

    const incomeRow = byId('incomeRow');
    const youIncome = byId('youIncome');
    const partnerIncome = byId('partnerIncome');

    const percentRow = byId('percentRow');
    const youPctInput = byId('youPct');
    const partnerPctTx = byId('partnerPctText');

    const warnBox = byId('warnBox');

    const inlinePriority = byId('inlinePriority');
    const inlineMonthly = byId('inlineMonthly');
    const inlineYearly  = byId('inlineYearly');

    const priorityTotalEl = byId('priorityTotal');
    const monthlyTotalEl  = byId('monthlyTotal');
    const yearlyTotalEl   = byId('yearlyTotal');
    const monthLabelEl    = byId('monthLabel');

    const partnerBreakEl = byId('partnerBreak');
    const splitDescEl = byId('splitDesc');

    const yourShareEl = byId('yourShare');
    const partnerShareEl = byId('partnerShare');
    const yourPriorityShareEl = byId('yourPriorityShare');
    const partnerPriorityShareEl = byId('partnerPriorityShare');

    const youIncomeOutEl = byId('youIncomeOut');
    const partnerIncomeOutEl = byId('partnerIncomeOut');
    const youLeftoverEl = byId('youLeftover');
    const partnerLeftoverEl = byId('partnerLeftover');

    // Extras rows
    function addExtraRow(label='', amount=''){
      const row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1.2fr 0.8fr';
      row.style.gap = '12px';
      row.style.marginBottom = '8px';

      const labelInput = document.createElement('input');
      labelInput.type = 'text';
      labelInput.placeholder = 'Label (e.g., Travel)';
      labelInput.value = label;
      labelInput.style.cssText = 'width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:rgba(255,255,255,0.10);color:#fff;';
      labelInput.addEventListener('input', calculate);

      const amountInput = document.createElement('input');
      amountInput.type = 'number';
      amountInput.placeholder = '0.00';
      amountInput.min = '0';
      amountInput.step = '0.01';
      amountInput.value = amount;
      amountInput.style.cssText = 'width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:rgba(255,255,255,0.10);color:#fff;';
      amountInput.addEventListener('input', calculate);

      row.appendChild(labelInput);
      row.appendChild(amountInput);
      extrasEl.appendChild(row);
    }

    addExtraRow(); addExtraRow(); addExtraRow();

    byId('addExtraBtn').addEventListener('click', e => {
      e.preventDefault();
      addExtraRow();
    });

    // Percent UI
    function updatePercent(){
      let p = parseFloat(youPctInput.value || 0);
      if (isNaN(p)) p = 0;
      if (p < 0) p = 0;
      if (p > 100) p = 100;
      youPctInput.value = p;
      partnerPctTx.textContent = (100 - p).toFixed(0);
    }

    // Gather extras
    function gatherExtras(){
      return Array.from(extrasEl.children).map(row=>{
        const inputs = row.querySelectorAll('input');
        const label = (inputs[0].value || 'Extra').trim();
        const amount = parseFloat(inputs[1].value || 0) || 0;
        return [label, amount];
      });
    }

    // Split helpers
    function incomeRatio(){
      const yi = parseFloat(youIncome.value || 0) || 0;
      const pi = parseFloat(partnerIncome.value || 0) || 0;
      const total = yi + pi;
      if (total <= 0) return { you: 0.5, partner: 0.5, needsIncome: true };
      return { you: yi/total, partner: pi/total, needsIncome: false };
    }

    function currentSplitMode(){
      if (splitPercent.checked) return 'percent';
      if (splitEqual.checked) return 'equal';
      if (splitIncomePriority.checked) return 'income_priority';
      return 'income_all'; // default
    }

    function calculate(){
      // Base expenses
      const rent = num('rent');
      const council = num('council');
      const wifi = num('wifi');
      const electricity = num('electricity');
      const water = num('water');
      const subs = num('subscriptions');

      const base = [
        ['Rent', rent],
        ['Council Tax', council],
        ['Wi-Fi', wifi],
        ['Electricity', electricity],
        ['Water', water],
        ['Subscriptions', subs]
      ];

      const extras = gatherExtras();

      const monthly = [...base, ...extras].reduce((s, [,v]) => s + (Number(v) || 0), 0);
      const yearly = monthly * 12;

      // Priority (must-pay) total
      const priority = rent + electricity + council + wifi;
      const nonPriority = Math.max(0, monthly - priority);

      // Always show totals as user types
      inlinePriority.textContent = toGBP(priority);
      inlineMonthly.textContent = toGBP(monthly);
      inlineYearly.textContent  = toGBP(yearly);

      priorityTotalEl.textContent = toGBP(priority);
      monthlyTotalEl.textContent = toGBP(monthly);
      yearlyTotalEl.textContent  = toGBP(yearly);

      const m = byId('monthInput').value || '';
      monthLabelEl.textContent = m ? `• ${m}` : '';

      // Partner split
      if (partnerTgl.checked){
        partnerBreakEl.style.display = 'block';

        const mode = currentSplitMode();
        let yourAll = 0, partnerAll = 0;
        let yourPri = 0, partnerPri = 0;

        // Build split based on mode
        if (mode === 'percent'){
          const youPct = parseFloat(youPctInput.value || 0) || 0;
          const y = Math.max(0, Math.min(100, youPct)) / 100;
          const p = 1 - y;

          yourAll = monthly * y;
          partnerAll = monthly * p;

          yourPri = priority * y;
          partnerPri = priority * p;

          splitDescEl.textContent = `Percentage (${(y*100).toFixed(0)}% / ${(p*100).toFixed(0)}%)`;
          warnBox.style.display = 'none';
        }
        else if (mode === 'equal'){
          yourAll = monthly / 2;
          partnerAll = monthly / 2;

          yourPri = priority / 2;
          partnerPri = priority / 2;

          splitDescEl.textContent = 'Equal (50% / 50%)';
          warnBox.style.display = 'none';
        }
        else {
          // income-based modes
          const r = incomeRatio();
          warnBox.style.display = r.needsIncome ? 'block' : 'none';

          if (mode === 'income_all'){
            yourAll = monthly * r.you;
            partnerAll = monthly * r.partner;

            yourPri = priority * r.you;
            partnerPri = priority * r.partner;

            splitDescEl.textContent = `By income (all) (${(r.you*100).toFixed(0)}% / ${(r.partner*100).toFixed(0)}%)`;
          } else {
            // income_priority + 50/50 rest
            yourPri = priority * r.you;
            partnerPri = priority * r.partner;

            const yourRest = nonPriority / 2;
            const partnerRest = nonPriority / 2;

            yourAll = yourPri + yourRest;
            partnerAll = partnerPri + partnerRest;

            splitDescEl.textContent = `Income priority + 50/50 rest (${(r.you*100).toFixed(0)}% / ${(r.partner*100).toFixed(0)}%)`;
          }
        }

        // Outputs
        yourShareEl.textContent = toGBP(yourAll);
        partnerShareEl.textContent = toGBP(partnerAll);

        yourPriorityShareEl.textContent = toGBP(yourPri);
        partnerPriorityShareEl.textContent = toGBP(partnerPri);

        const yi = parseFloat(youIncome.value || 0) || 0;
        const pi = parseFloat(partnerIncome.value || 0) || 0;

        youIncomeOutEl.textContent = toGBP(yi);
        partnerIncomeOutEl.textContent = toGBP(pi);

        youLeftoverEl.textContent = toGBP(yi - yourAll);
        partnerLeftoverEl.textContent = toGBP(pi - partnerAll);
      } else {
        partnerBreakEl.style.display = 'none';
        warnBox.style.display = 'none';
      }
    }

    function refreshPartnerUI(){
      const show = partnerTgl.checked;
      incomeRow.style.display = show ? 'block' : 'none';
      percentRow.style.display = (show && splitPercent.checked) ? 'block' : 'none';
      updatePercent();
      calculate();
    }

    // Panel toggle
    function toggle(el){
      el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
    }
    byId('fabBtn').addEventListener('click', ()=>toggle(byId('panel')));

    // Wire up inputs for live calculations
    [
      'monthInput','rent','council','wifi','electricity','water','subscriptions',
      'partnerToggle','youIncome','partnerIncome','youPct'
    ].forEach(id => byId(id).addEventListener('input', calculate));

    partnerTgl.addEventListener('change', refreshPartnerUI);
    splitIncomeAll.addEventListener('change', refreshPartnerUI);
    splitIncomePriority.addEventListener('change', refreshPartnerUI);
    splitEqual.addEventListener('change', refreshPartnerUI);
    splitPercent.addEventListener('change', refreshPartnerUI);

    // Export CSV
    byId('exportBtn').addEventListener('click', () => {
      const month = byId('monthInput').value || 'Unspecified';

      const rent = num('rent');
      const council = num('council');
      const wifi = num('wifi');
      const electricity = num('electricity');
      const water = num('water');
      const subs = num('subscriptions');

      const base = [
        ['Rent', rent],
        ['Council Tax', council],
        ['Wi-Fi', wifi],
        ['Electricity', electricity],
        ['Water', water],
        ['Subscriptions', subs]
      ];
      const extras = gatherExtras();

      const monthly = [...base, ...extras].reduce((s, [,v]) => s + (Number(v)||0), 0);
      const yearly = monthly * 12;

      const priority = rent + electricity + council + wifi;
      const nonPriority = Math.max(0, monthly - priority);

      const rows = [
        ['Month', month],
        ['Priority Bills Total', priority.toFixed(2)],
        ['Non-Priority Total', nonPriority.toFixed(2)],
        ...base,
        ...extras,
        ['Monthly Total', monthly.toFixed(2)],
        ['Yearly Total', yearly.toFixed(2)]
      ];

      if (partnerTgl.checked){
        const mode = currentSplitMode();

        let yourAll = 0, partnerAll = 0, yourPri = 0, partnerPri = 0;
        let desc = '';

        if (mode === 'percent'){
          const youPct = parseFloat(youPctInput.value || 0) || 0;
          const y = Math.max(0, Math.min(100, youPct)) / 100;
          const p = 1 - y;
          yourAll = monthly * y; partnerAll = monthly * p;
          yourPri = priority * y; partnerPri = priority * p;
          desc = `Percentage (${(y*100).toFixed(0)}% / ${(p*100).toFixed(0)}%)`;
        } else if (mode === 'equal'){
          yourAll = monthly/2; partnerAll = monthly/2;
          yourPri = priority/2; partnerPri = priority/2;
          desc = 'Equal (50% / 50%)';
        } else {
          const r = incomeRatio();
          if (mode === 'income_all'){
            yourAll = monthly * r.you; partnerAll = monthly * r.partner;
            yourPri = priority * r.you; partnerPri = priority * r.partner;
            desc = `By income (all) (${(r.you*100).toFixed(0)}% / ${(r.partner*100).toFixed(0)}%)`;
          } else {
            yourPri = priority * r.you; partnerPri = priority * r.partner;
            yourAll = yourPri + (nonPriority/2);
            partnerAll = partnerPri + (nonPriority/2);
            desc = `Income priority + 50/50 rest (${(r.you*100).toFixed(0)}% / ${(r.partner*100).toFixed(0)}%)`;
          }
        }

        const yi = parseFloat(youIncome.value || 0) || 0;
        const pi = parseFloat(partnerIncome.value || 0) || 0;

        rows.push(['Split Type', desc]);
        rows.push(['Your Share (Priority)', yourPri.toFixed(2)]);
        rows.push(['Partner Share (Priority)', partnerPri.toFixed(2)]);
        rows.push(['Your Share (All Bills)', yourAll.toFixed(2)]);
        rows.push(['Partner Share (All Bills)', partnerAll.toFixed(2)]);
        rows.push(['Your Income', yi.toFixed(2)]);
        rows.push(['Partner Income', pi.toFixed(2)]);
        rows.push(['Your Leftover After Bills', (yi - yourAll).toFixed(2)]);
        rows.push(['Partner Leftover After Bills', (pi - partnerAll).toFixed(2)]);
      }

      const csv =
        'data:text/csv;charset=utf-8,' +
        'Category,Amount (£)\n' +
        rows.map(r => r.map(x => String(x).replaceAll(',', ' ')).join(',')).join('\n');

      const a = document.createElement('a');
      a.href = encodeURI(csv);
      a.download = `monthly_expenses_${month.replace(/-/g,'_') || 'unspecified'}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // Reset
    byId('resetBtn').addEventListener('click', () => {
      [
        'rent','council','wifi','electricity','water','subscriptions',
        'youIncome','partnerIncome'
      ].forEach(id => byId(id).value='');

      byId('monthInput').value = '';

      partnerTgl.checked = false;
      splitIncomeAll.checked = true;
      splitIncomePriority.checked = false;
      splitEqual.checked = false;
      splitPercent.checked = false;

      youPctInput.value = 50;
      updatePercent();

      extrasEl.innerHTML = '';
      addExtraRow(); addExtraRow(); addExtraRow();

      refreshPartnerUI();
      calculate();
    });

    // Init
    updatePercent();
    refreshPartnerUI();
    calculate();
  </script>
</body>
</html>
